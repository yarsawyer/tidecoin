# AuxPoW Functional Tests (How To Run)

This repo includes Tidecoin functional tests for AuxPoW/merge-mining RPC and P2P behavior:

- `test/functional/auxpow_mining.py` (getauxblock/createauxblock/submitauxblock + basic block contents)
- `test/functional/auxpow_invalidpow.py` (invalid parent PoW rejection)
- `test/functional/auxpow_zerohash.py` (P2P block retrieval / disk serving for AuxPoW blocks)

Notes:
- These tests are designed for Tidecoin regtest where AuxPoW is active from height 0:
  - `src/kernel/chainparams.cpp`: `consensus.nAuxpowStartHeight = 0`, `consensus.nAuxpowChainId = 8`
- The functional test framework uses a cached chain tip at height 199. On Tidecoin regtest, the subsidy at that height can be < 1 TDC due to `nSubsidyHalvingInterval = 20`, so tests must not assume coinbase payout is `>= 1`.

## Prerequisites

- Built node binaries (at least `tidecoind`, `tidecoin-cli`, `tidecoin-tx`).
- Wallet compiled in (the tests use `MiniWallet`; if wallet is disabled, `auxpow_mining.py` will skip).
- Python 3.
  - The AuxPoW test code uses `hashlib.scrypt` (no external scrypt module dependency).

## Config File

This repo uses the standard functional-test config file location:

- `build/test/config.ini` (generated by CMake)
- `test/config.ini` is a symlink to `../build/test/config.ini`

The examples below pass `--configfile=build/test/config.ini` explicitly to avoid ambiguity.

## Run A Single AuxPoW Test

From the repo root:

```bash
python3 test/functional/auxpow_mining.py --configfile=build/test/config.ini
python3 test/functional/auxpow_invalidpow.py --configfile=build/test/config.ini
python3 test/functional/auxpow_zerohash.py --configfile=build/test/config.ini
```

Useful debugging flags (from the framework):

```bash
python3 test/functional/auxpow_mining.py --configfile=build/test/config.ini --nocleanup --loglevel=DEBUG
```

## Run All AuxPoW Tests Via The Runner

Run just the AuxPoW scripts (recommended if you want parallelism and consistent output):

```bash
python3 test/functional/test_runner.py --configfile=build/test/config.ini --filter='auxpow_'
```

Or list them explicitly:

```bash
python3 test/functional/test_runner.py --configfile=build/test/config.ini \
  auxpow_mining.py auxpow_invalidpow.py auxpow_zerohash.py
```

## If You Change The AuxPoW Chain ID

The functional-test framework has a chain-id constant used by AuxPoW message encoding:

- `test/functional/test_framework/messages.py`: `CHAIN_ID`

If `consensus.nAuxpowChainId` changes in `src/kernel/chainparams.cpp`, update `CHAIN_ID` accordingly or the tests will mine for the wrong chain id and fail.

