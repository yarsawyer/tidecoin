# PQ Test Framework Migration Plan

Goal: remove all secp/Schnorr assumptions from tests and make all key generation/ signing PQ‑native.

## Scope
- Functional tests (`test/functional/**`)
- Test framework (`test/functional/test_framework/**`)
- C++ unit tests (`src/test/**`, `src/test/fuzz/**`)
- Test data fixtures that embed secp keys/WIFs

## Constraints
- **No Python keygen/crypto**. PQ keys must be generated by C/C++ using in‑tree PQ libs.
- Tests must cover **all PQ schemes** (Falcon‑512 pre‑auxpow; all schemes post‑auxpow).
- All key material must be derived via **wallet RPC** or **new C++ test key tool**.

---

## PR‑T0 — Add PQ test key generator tool (C++ only)
**Purpose:** Provide deterministic PQ keys for tests without Python crypto.

**Add target:** `src/test/` (new binary)
- Suggested name: `tidecoin-testkeys`

**Features:**
- Accept: `--scheme`, `--seed`, `--count`, `--output=json`
- Output: `scheme_id`, `privkey_wif`, `pubkey_hex`, `address`, optional descriptor
- Must use core PQ APIs and PQHD keygen paths

**Touchpoints:**
- `src/test/CMakeLists.txt`
- `src/test/pq_testkeys.cpp` (new)
- `src/pq/pq_api.h` (if helper exposure needed)

**Acceptance:**
- Binary builds in standard + dev builds
- Produces deterministic PQ keys across schemes

---

## PR‑T1 — Test framework cleanup (remove secp/Schnorr)
**Purpose:** remove Python secp keygen and direct ECDSA/Schnorr helpers.

**Delete/retire:**
- `test/functional/test_framework/key.py`
- `test/functional/test_framework/crypto/secp256k1.py`

**Refactor:**
- `test_framework/wallet_util.py`
  - Replace `generate_keypair()` and `get_generate_key()` to use:
    - PQ wallet RPC (default)
    - fallback to `tidecoin-testkeys` if no wallet
- `test_framework/script.py`
  - Remove `sign_input_legacy`, `sign_input_segwitv0` (ECDSA)
  - Replace with RPC signing paths only
 - Zero‑node tool tests should **disable the network thread** to avoid shutdown hangs:
   - `test/functional/tool_utils.py`
   - `test/functional/tool_rpcauth.py`
   - `test/functional/create_cache.py`

**Acceptance:**
- No imports of `ECKey`, `secp256k1`, or schnorr helpers in Python
- Framework still passes basic wallet‑based tests
 - Zero‑node tool tests exit cleanly without NetworkThread

---

## PR‑T2 — Replace secp WIF usage in functional tests
**Purpose:** convert all tests to PQ WIFs or PQ pubkeys.

**High impact tests:**
- `wallet_importdescriptors.py`
- `wallet_balance.py`
- `wallet_send.py`
- `wallet_migration.py`
- `rpc_psbt.py`
- `rpc_createmultisig.py`
- `wallet_listsinceblock.py`
- `wallet_importprunedfunds.py`
- `feature_nulldummy.py`
- `mempool_accept.py`
- `mempool_sigoplimit.py`
- `feature_assumevalid.py`
- `feature_block.py`
- `wallet_fast_rescan.py`
- `wallet_listtransactions.py`
- `feature_segwit.py`
- `wallet_fundrawtransaction.py`
- `rpc_getdescriptorinfo.py`
- `p2p_segwit.py`

**Rules:**
- All WIFs must be PQ WIF (new encoding)
- Descriptors must use PQ pubkey bytes (prefixed)
- `importprivkey` should be removed/replaced (descriptor import only)

**Acceptance:**
- All tests pass with PQ wallet key material
- No secp WIFs remain in scripts

**Status:** In progress (partial conversions + targeted skips)
- Converted:
  - `test/functional/mempool_dust.py` (remove compressed/uncompressed paths)
  - `test/functional/rpc_generate.py` (PQ combo descriptor + PQ address)
  - `test/functional/rpc_decodescript.py` (PQ pubkeys, remove uncompressed paths)
  - `test/functional/rpc_signmessagewithprivkey.py` (PQ WIF, no hardcoded signature)
  - `test/functional/wallet_migration.py` (remove compressed/uncompressed paths; no RPC importprivkey)
  - `test/functional/p2p_segwit.py` (drop compressed arg in skipped test)
  - `test/functional/wallet_basic.py` (PQ multisig descriptors for parent_descs)
  - `test/functional/wallet_listsinceblock.py` (PQ multisig descriptors)
  - `test/functional/wallet_avoidreuse.py` (descriptor flags only; drop xpub cached flag)
  - `test/functional/wallet_address_types.py` (PQ descriptors; drop BIP32 derivs)
  - `test/functional/wallet_importdescriptors.py` (PQ descriptors; WIF-based import; remove xpub/xprv sections)
  - `test/functional/rpc_deriveaddresses.py` (PQ pubkey/WIF descriptors; drop xpub ranges)
  - `test/functional/rpc_getdescriptorinfo.py` (PQ descriptors; remove xpub/multipath vectors)
  - `test/functional/wallet_createwalletdescriptor.py` (expects PQHD-only error)
  - `test/functional/wallet_gethdkeys.py` (expects PQHD-only error)
  - `test/functional/wallet_listdescriptors.py` (PQHD listdescriptors behavior)
  - `test/functional/wallet_keypool.py` (PQHD keypool behavior; no xprv)
  - `test/functional/wallet_descriptor.py` (PQHD-only descriptor wallet behavior)
  - `test/functional/wallet_createwallet.py` (PQHD-only blank wallet behavior; no xprv)
  - `test/functional/feature_notifications.py` (PQ WIF descriptors)
  - `test/functional/wallet_multisig_descriptor_psbt.py` (PQ WIF + pubkey multisig)
  - `test/functional/wallet_bumpfee.py` (PQ WIF descriptors; no xprv)
  - `test/functional/wallet_fundrawtransaction.py` (PQ WIF descriptors; no xprv)
  - `test/functional/rpc_scantxoutset.py` (PQ pubkey descriptors; no xpub)
  - `test/functional/rpc_scanblocks.py` (PQ pubkey descriptors; no xpub)
  - `test/functional/wallet_miniscript.py` (PQ WIF/pubkey miniscript, no ranges)
  - `test/functional/wallet_miniscript_decaying_multisig_descriptor_psbt.py` (PQ pubkey miniscript, no xpub)
- Temporarily skipped (PQ rewrite needed):
  - `test/functional/wallet_signer.py` (external signer relies on xpub-based ranged descriptors)
  - `test/functional/rpc_signer.py` (external signer relies on xpub-based ranged descriptors)
 - Re‑enabled:
  - `test/functional/tool_utils.py` (PQ vectors regenerated; order fixed for sign+outaddr)
    - Updated/added: `test/functional/data/util/bitcoin-util-test.json`
    - New verify inputs: `txcreatesignv1-verify.json`, `txcreatesignv2-verify.json`, `txcreatesignsegwit1-verify.json`
    - Updated scriptPubKey + signed hex outputs for PQ WIFs

---

## PR‑T3 — Update C++ unit tests and fuzz
**Targets:**
- `src/test/rpc_tests.cpp` (remove secp WIFs)
- `src/test/util_tests.cpp` (remove MessageSign / secp CKey)
- `src/test/fuzz/util/descriptor.cpp` (remove EncodeSecret with secp)

**Acceptance:**
- No secp key paths used in C++ tests

---

## PR‑T4 — Replace static test fixtures
**Targets:**
- `test/functional/data/rpc_psbt.json`

**Action:**
- Regenerate fixtures using PQ WIF and PQ pubkeys (new tool or RPC)

---

## PR‑T5 — Scheme coverage expansion
**Purpose:** ensure tests exercise all PQ schemes.

**Add:**
- Parameterized tests across schemes in:
  - descriptor import
  - signing
  - multisig
  - wallet address generation

**Acceptance:**
- Falcon‑512 only pre‑auxpow
- Full scheme set post‑auxpow

---

## PR‑T6 — Deprecation audit
**Purpose:** ensure no secp references remain in test docs.

**Check:**
- `test/functional/README.md`
- `test/lint` hints
- any mentions of secp or schnorr

---

## Checklist (tracking)
- [x] PR‑T0: PQ test keygen tool
- [x] PR‑T1: Framework cleanup
- [ ] PR‑T2: Functional tests PQ conversion
- [ ] PR‑T3: C++ unit/fuzz cleanup
- [ ] PR‑T4: Fixtures regenerated
- [ ] PR‑T5: Scheme coverage expansion
- [ ] PR‑T6: Deprecation audit
